<% layout("/layouts/boilerplate") %>

<style>
  .show-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 1rem;
  }
  .show-img {
    width: 100%;
    height: 400px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
  .detail-item {
    margin-bottom: 0.5rem;
  }
  .detail-icon {
    color: #fe424d;
    margin-right: 0.5rem;
  }
</style>

<div class="show-container">
  <h2 class="mb-3"><%= showListing.title %></h2>
  <img src="<%= showListing.image %>" class="show-img" alt="<%= showListing.title %>" 
       onerror="this.src='https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60'">
  
  <div class="mb-3">
    <strong>Owned by: <%= showListing.owner.username %></strong>
  </div>
  
  <p class="mb-3"><%= showListing.description %></p>
  
  <div class="detail-item">
    <span class="detail-icon"><i class="fas fa-rupee-sign"></i></span>
    <span>&#8377;<%= showListing.price ? showListing.price.toLocaleString("en-IN") : "N/A" %> per night</span>
  </div>
  
  <div class="detail-item">
    <span class="detail-icon"><i class="fas fa-map-marker-alt"></i></span>
    <span><%= showListing.location %></span>
  </div>
  
  <div class="detail-item">
    <span class="detail-icon"><i class="fas fa-globe"></i></span>
    <span><%= showListing.country %></span>
  </div>

  <% if(currentUser && showListing.owner._id.equals(currentUser._id)) { %>
    <div class="mt-4">
      <a class="btn btn-primary me-2" href="/listings/<%=showListing._id%>/edit">Edit</a>
      <form method="POST" action="/listings/<%= showListing._id %>?_method=DELETE" class="d-inline">
        <button class="btn btn-danger">Delete</button>
      </form>
    </div>
  <% } %>

  <% if(currentUser && !showListing.owner._id.equals(currentUser._id)) { %>
    <hr class="my-4">
    <h4>Leave Feedback</h4>
    <form action="/listings/<%= showListing._id%>/reviews" method="POST">
      <div class="mb-3">
        <label class="form-label">Rating:</label>
        <select name="review[rating]" class="form-select">
          <option value="1">1 Star</option>
          <option value="2">2 Stars</option>
          <option value="3">3 Stars</option>
          <option value="4">4 Stars</option>
          <option value="5">5 Stars</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="comment" class="form-label">Comment:</label>
        <textarea class="form-control" name="review[comment]" rows="3" required></textarea>
      </div>
      <button type="submit" class="btn btn-success">Submit Review</button>
    </form>
  <% } %>

  <hr class="my-4">
  <h4 class="text-center">Customer Reviews</h4>
  <% if (showListing.reviews && showListing.reviews.length > 0) { %>
    <% showListing.reviews.forEach(review => { %>
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <h5>@<%= review.createdBy.username %></h5>
            <div>Rating: <%= review.rating %>/5</div>
          </div>
          <p class="mt-2"><%= review.comment %></p>
          <small class="text-muted">
            <%= new Date(review.createdAt).toLocaleDateString() %>
          </small>
          <% if(currentUser && (review.createdBy._id.equals(currentUser._id) || showListing.owner._id.equals(currentUser._id))) { %>
            <form action="/listings/<%= showListing._id%>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="mt-2">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          <% } %>
        </div>
      </div>
    <% }); %>
  <% } else { %>
    <p class="text-center text-muted">No reviews yet.</p>
  <% } %>
</div>